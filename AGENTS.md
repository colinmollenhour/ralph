# Ralph Agent Instructions

## Overview

Ralph is an autonomous AI agent loop that runs AI coding tools (Amp, Claude Code, or OpenCode) repeatedly until all implementation tasks are complete. Each iteration is a fresh instance with clean context. Tasks come from Agent SOP-style planning directories containing `.code-task.md` specification files.

## Commands

```bash
# Run Ralph (interactive chooser if no path given)
./ralph.sh

# Run specific Ralph project (by planning directory)
./ralph.sh planning/auth
./ralph.sh planning/auth/implementation/ralph.json

# Run with iteration limit
./ralph.sh planning/auth -n 10
./ralph.sh -n 10 planning/auth  # Either order works

# Debug: See next prompt without invoking LLM
./ralph.sh planning/auth --next-prompt

# Run with different tools
./ralph.sh planning/auth --tool claude
./ralph.sh planning/auth --tool opencode

# Stop a running Ralph project
./ralph.sh --stop planning/auth

# Run with learning absorption
./ralph.sh planning/auth --learn           # Normal execution + learn on final iteration
./ralph.sh planning/auth --learn-now       # Just run learn prompt, no tasks

# Run in isolated git worktree
./ralph.sh planning/auth --worktree        # Creates .worktrees/auth/ and runs there

# Run the flowchart dev server
cd flowchart && npm run dev

# Build the flowchart
cd flowchart && npm run build
```

## Key Files

- `ralph.sh` - Main loop script with embedded agent prompt
- `skills/ralph-sop/SKILL.md` - Skill to generate ralph.json from a planning directory
- Planning directories follow the Agent SOP convention:
  - `summary.md` - Project overview
  - `research/*.md` - Codebase research documents
  - `design/detailed-design.md` - Technical design
  - `implementation/plan.md` - Step-by-step implementation plan
  - `implementation/step{NN}/task-{NN}-*.code-task.md` - Individual task specs
  - `implementation/ralph.json` - Execution tracker (generated by ralph-sop skill)
  - `implementation/progress.md` - Append-only iteration log
  - `memory.md` - Learnings file (created by ralph.sh on first task)

## Flowchart

The `flowchart/` directory contains an interactive visualization built with React Flow. It's designed for presentations - click through to reveal each step with animations.

To run locally:
```bash
cd flowchart
npm install
npm run dev
```

## Patterns

- Each iteration spawns a fresh AI instance (Amp, Claude Code, or OpenCode) with clean context
- Memory persists via git history, `progress.md`, `ralph.json`, and `memory.md`
- Tasks should be small enough to complete in one context window
- Always update memory.md with discovered patterns for future iterations
- **Early exit optimization**: The loop checks if all tasks are complete at the start of each iteration
- **Failure detection**: Iterations completing in less than 4 seconds are flagged as potential failures. After 5 consecutive quick failures, Ralph exits with an error to prevent rate limiting and catch configuration issues (e.g., invalid model names)
- **Default iterations**: Set to 50 since early exit optimization prevents wasted iterations when work is complete

## Token Efficiency Patterns

Ralph references task spec files by path rather than injecting their content. The agent reads the `.code-task.md` file which is self-contained with description, requirements, acceptance criteria, and references to design/research docs.

### Progress File Format

Simple iteration history in `implementation/progress.md`:

```
### [2026-01-14 10:30] - S01-T02
Implemented: Lot number generator with pattern parsing and counter logic
Files changed:
- app/code/core/MWE/Stock/Model/Lot/Type.php (modified)
- app/code/core/MWE/Stock/Test/Model/Lot/Type/GeneratorTest.php (created)
---
```

### Learnings Storage

Learnings are stored in `<planning-dir>/memory.md` (created automatically on first task execution).
Use `--learn` or `--learn-now` flags to absorb learnings into the project root `./AGENTS.md`.
